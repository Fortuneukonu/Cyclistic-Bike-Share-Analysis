import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import matplotlib.ticker as ticker
import gc

# --- CONFIGURATION ---
input_file = r"C:\Users\USER\Documents\DATA ANALYTICS PORTFOLIO\Cyclistic Case Study\Working Data\cyclistic_annual_clean.csv"

# Set plot style for consistency
plt.style.use('seaborn-v0_8-darkgrid')

# --- 1. LOAD DATA (Lightweight) ---
print("Loading data for visualization...")
# We load only columns needed for the charts to save memory
df = pd.read_csv(input_file, usecols=['started_at', 'member_casual', 'day_of_week'])

# Pre-process dates
df['started_at'] = pd.to_datetime(df['started_at'])
df['month'] = df['started_at'].dt.month_name()
df['start_hour'] = df['started_at'].dt.hour

# --- CHART 1: WEEKLY USAGE (Bar Chart) ---
print("Generating Chart 1: Weekly Usage...")

day_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
daily_counts = df.groupby(['day_of_week', 'member_casual']).size().reset_index(name='Ride Count')

plt.figure(figsize=(10, 6))
ax1 = sns.barplot(
    data=daily_counts, x='day_of_week', y='Ride Count', 
    hue='member_casual', order=day_order, palette='Paired'
)
plt.title('Weekly Riding Patterns: Commuter vs. Leisure', fontsize=16, fontweight='bold')
plt.xlabel('Day of Week', fontsize=12)
plt.ylabel('Total Rides', fontsize=12)
plt.legend(title='User Type')
ax1.yaxis.set_major_formatter(ticker.FuncFormatter(lambda x, pos: '{:,.0f}'.format(x)))
plt.show()

# --- CHART 2: HOURLY HEARTBEAT (Line Chart) ---
print("Generating Chart 2: Hourly Usage...")

hourly_counts = df.groupby(['start_hour', 'member_casual']).size().reset_index(name='Ride Count')

plt.figure(figsize=(12, 6))
ax2 = sns.lineplot(
    data=hourly_counts, x='start_hour', y='Ride Count', 
    hue='member_casual', palette='coolwarm', linewidth=2.5
)
plt.title('Hourly Usage: Identifying Commuter Spikes', fontsize=16, fontweight='bold')
plt.xlabel('Hour of Day (24-Hour Clock)', fontsize=12)
plt.ylabel('Number of Rides', fontsize=12)
plt.xticks(range(0, 24))
plt.axvline(x=8, color='gray', linestyle='--', alpha=0.5)
plt.axvline(x=17, color='gray', linestyle='--', alpha=0.5)
ax2.yaxis.set_major_formatter(ticker.FuncFormatter(lambda x, pos: '{:,.0f}'.format(x)))
plt.show()

# --- CHART 3: SEASONALITY (Line Chart) ---
print("Generating Chart 3: Seasonality...")

# Define chronological order for the last 12 months (Dec 2024 - Nov 2025)
chronological_order = [
    'December', 'January', 'February', 'March', 'April', 'May', 
    'June', 'July', 'August', 'September', 'October', 'November'
]
df['month'] = pd.Categorical(df['month'], categories=chronological_order, ordered=True)

# Group by month (using observed=False to silence warnings)
monthly_counts = df.groupby(['month', 'member_casual'], observed=False).size().reset_index(name='Ride Count')

plt.figure(figsize=(12, 6))
ax3 = sns.lineplot(
    data=monthly_counts, x='month', y='Ride Count', 
    hue='member_casual', palette='viridis', linewidth=3, marker='o'
)
plt.title('Ridership Trends (Dec 2024 - Nov 2025)', fontsize=16, fontweight='bold')
plt.xlabel('Month', fontsize=12)
plt.ylabel('Number of Rides', fontsize=12)
plt.xticks(rotation=45)
ax3.yaxis.set_major_formatter(ticker.FuncFormatter(lambda x, pos: '{:,.0f}'.format(x)))
plt.show()

print("All charts generated.")
